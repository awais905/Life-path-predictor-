<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Life Path Oracle — Created by BHuTTa</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Noto+Nastaliq+Urdu:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#08090b; --bg2:#0f1724;
      --muted:#9aa4b2; --text:#e6eef8;
      --accent:#d9b8ff; --gold:#d4af37; --card:#0f1726;
      --glass: rgba(255,255,255,0.03);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,"Noto Nastaliq Urdu",sans-serif;background:
      radial-gradient(600px 400px at 10% 0%, rgba(212,175,55,0.03), transparent),
      linear-gradient(180deg,var(--bg1),var(--bg2)); color:var(--text);}
    .wrap{max-width:1100px;margin:18px auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:14px}
    .logo{
      width:56px;height:56px;border-radius:12px;background:conic-gradient(from 200deg,#ffd873,#b886ff 50%,#60f0ff);
      box-shadow:0 12px 30px rgba(0,0,0,.6);
    }
    h1{margin:0;font-weight:800;font-size:clamp(20px,3.4vw,36px)}
    .subtitle{color:var(--muted);font-size:13px}
    .controls{display:flex;align-items:center;gap:10px}
    select.lang{background:var(--glass);border:1px solid rgba(255,255,255,.04);padding:8px 10px;border-radius:10px;color:var(--text)}
    .btn{appearance:none;border:none;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.06);color:var(--text)}
    .btn.primary{background:linear-gradient(135deg,var(--gold),#f0c85a);color:#111}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:20px;margin-top:18px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));padding:18px;border-radius:var(--radius);border:1px solid rgba(255,255,255,.04)}
    label{display:block;font-size:13px;color:var(--muted);margin-top:12px}
    input,select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.04);background:rgba(255,255,255,.01);color:var(--text);outline:none}
    .actions{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
    .chip{display:inline-block;padding:8px 10px;border-radius:999px;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.04);font-size:13px}
    .result-area{margin-top:12px}
    .tile{background:rgba(255,255,255,.02);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.04);margin-top:12px}
    .tile h3{margin:0 0 8px;font-size:16px}
    .tile p{margin:0;color:#cbd5e1;line-height:1.6;white-space:pre-wrap}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
    .kpi{background:rgba(255,255,255,.02);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.04)}
    .kpi .label{font-size:12px;color:var(--muted)}
    .kpi .value{font-weight:800;margin-top:6px}
    .signature{margin-top:18px;text-align:center;font-weight:900;color:var(--gold);font-size:15px}
    footer{margin-top:26px;color:var(--muted);font-size:12px;text-align:center}

    /* Modal (History) */
    .overlay{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:2000}
    .modal{background:linear-gradient(180deg, #071016, #0b1320);width:92%;max-width:920px;border-radius:14px;padding:18px;border:1px solid rgba(255,255,255,.04);box-shadow:0 20px 60px rgba(0,0,0,.6);transform:scale(.98);opacity:0;transition:all .18s ease;max-height:85vh;overflow:hidden}
    .modal.open{transform:none;opacity:1}
    .modal-head{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .search{flex:1;margin:0 12px}
    .history-list{margin-top:12px;max-height:56vh;overflow:auto;padding-right:6px}
    .history-card{background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.03);padding:12px;border-radius:10px;margin-bottom:10px;display:flex;flex-direction:column;gap:8px}
    .history-card .meta{display:flex;justify-content:space-between;gap:10px;font-size:13px;color:var(--muted)}
    .history-card:hover{box-shadow:0 10px 30px rgba(0,0,0,.6)}
    .history-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:6px}
    .btn-danger{background:#ef4444;color:white;border-radius:8px;padding:8px 10px;font-weight:700;border:none;cursor:pointer}
    .btn-gold{background:linear-gradient(135deg,var(--gold),#f0c85a);color:#111;border-radius:8px;padding:8px 10px;font-weight:800;border:none;cursor:pointer}

    /* small screens */
    @media(max-width:680px){
      .kpis{grid-template-columns:1fr}
      .modal{padding:12px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1 id="appTitle">Life Path Oracle</h1>
          <div class="subtitle" id="appSubtitle">Detailed, serious readings — Past · Present · Future · All aspects</div>
        </div>
      </div>

      <div class="controls">
        <select id="langSel" class="lang" aria-label="Language">
          <option value="en">English</option>
          <option value="ur">اردو</option>
          <option value="sr">سرائیکی</option>
        </select>
        <button class="btn ghost" id="shareBtn" title="Copy share link">Share Link</button>
        <button class="btn ghost" id="historyBtn" title="View History">View History</button>
      </div>
    </header>

    <div class="grid">
      <!-- Form -->
      <main class="card">
        <form id="form">
          <label id="lblName">Full Name</label>
          <input id="name" name="name" placeholder="e.g., Awais Aziz" required>

          <label id="lblFather">Father's Name</label>
          <input id="father" name="father" placeholder="e.g., Aziz Muhammad" required>

          <label id="lblDob">Date of Birth</label>
          <input id="dob" name="dob" type="date" required>

          <label id="lblPlace">Place of Birth (optional)</label>
          <input id="place" name="place" placeholder="City, Country">

          <label id="lblGender">Gender (optional)</label>
          <select id="gender" name="gender">
            <option value="">Prefer not to say</option>
            <option>Male</option>
            <option>Female</option>
            <option>Other</option>
          </select>

          <label id="lblFocus">Focus / Question (optional)</label>
          <input id="focus" name="focus" placeholder="e.g., career, love, health...">

          <div class="actions">
            <button type="submit" class="btn primary" id="predictBtn">Predict My Life</button>
            <button type="reset" class="btn ghost">Clear</button>
            <button type="button" class="btn ghost" id="quickExample">Example</button>
          </div>
        </form>

        <div id="resultArea" class="result-area" style="display:none">
          <div class="tile">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
              <div>
                <strong id="resName">—</strong>
                <div class="subtitle" id="resSub">Detailed life reading</div>
              </div>
              <div class="chip" id="chips"></div>
            </div>

            <div class="kpis" id="kpis"></div>

            <div id="sections"></div>

            <div style="display:flex;gap:8px;justify-content:center;margin-top:14px">
              <button class="btn ghost" id="copyBtn">Copy Reading</button>
              <button class="btn ghost" id="downloadSingleBtn">Download PDF</button>
              <button class="btn ghost" id="saveLocalBtn">Save to History</button>
            </div>

            <div class="signature" id="signature">Created by BHuTTa ✨</div>
          </div>
        </div>
      </main>

      <!-- Aside Info -->
      <aside class="card">
        <div><strong id="asideTitle">Quick Info</strong></div>
        <p id="asideText">Fill the form and receive an in-depth reading that covers personality, relationships, career, health, finance, spirituality and practical advice. All calculations run locally in your browser.</p>

        <div style="margin-top:12px">
          <div class="chip" id="lifePathChip">Life Path: —</div>
          <div class="chip" id="nameNumChip">Name #: —</div>
          <div class="chip" id="fatherNumChip">Father #: —</div>
        </div>
      </aside>
    </div>

    <footer>Note: This tool provides reflective guidance based on numerology techniques. Not medical/financial advice.</footer>
  </div>

  <!-- History Modal -->
  <div class="overlay" id="overlay">
    <div class="modal" id="modal">
      <div class="modal-head">
        <div>
          <h3 style="margin:0;color:var(--gold)">📜 Reading History</h3>
          <div class="subtitle" id="modalSubtitle">Saved readings (local device)</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="histSearch" class="search" placeholder="Search name or DOB..." oninput="renderHistory()" />
          <button class="btn btn-gold" id="exportAllBtn">Download All PDF</button>
          <button class="btn btn-danger" id="clearAllBtn">Clear All</button>
          <button class="btn ghost" id="closeModalBtn">Close</button>
        </div>
      </div>

      <div class="history-list" id="historyList"></div>
    </div>
  </div>

  <!-- Libraries for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
  /* ---------------------- Utilities & Numerology Engine ---------------------- */

  const isMaster = (n) => [11,22,33].includes(n);
  function digitalRootNum(n){
    while(n>9 && !isMaster(n)){
      n = n.toString().split('').reduce((a,b)=>a+Number(b),0);
    }
    return n;
  }

  // Pythagorean mapping A..Z -> 1..9 cycle
  const lettersMap = (() => {
    const m = {};
    for(let i=0;i<26;i++){
      m[String.fromCharCode(65+i)] = (i%9)+1;
    }
    return m;
  })();
  const normalize = s => (s||'').toUpperCase().replace(/[^A-Z]/g,'');

  function nameNumber(str){
    const s = normalize(str);
    if(!s) return 0;
    const sum = [...s].reduce((t,ch)=> t + (lettersMap[ch]||0), 0);
    return digitalRootNum(sum);
  }
  function lifePathFromDOB(dob){
    const digits = (dob||'').replace(/\D/g,'');
    if(!digits) return 0;
    const sum = digits.split('').reduce((a,b)=>a+Number(b),0);
    return digitalRootNum(sum);
  }

  function getColorNameByNumber(n, lang='en'){
    const mapEN = {1:'Crimson',2:'Silver',3:'Saffron',4:'Forest Green',5:'Cyan',6:'Pearl',7:'Indigo',8:'Charcoal',9:'Gold',11:'Violet',22:'Royal Blue',33:'Rose'};
    const mapUR = {1:'سرخ',2:'چاندی',3:'زعفران',4:'سبز جنگل',5:'نیلا ہلکا',6:'موتی',7:'نیلا جامنی',8:'سیاہ خاکی',9:'سونا',11:'بنفشی',22:'شاہی نیلا',33:'گلابی'};
    const mapSR = mapUR;
    if(lang==='ur') return mapUR[n] || 'نیل';
    if(lang==='sr') return mapSR[n] || 'نیل';
    return mapEN[n] || 'Teal';
  }
  function getStoneByNumber(n, lang='en'){
    const mapEN = {1:'Red Jasper',2:'Moonstone',3:'Citrine',4:'Hematite',5:'Turquoise',6:'Rose Quartz',7:'Amethyst',8:'Smoky Quartz',9:'Clear Quartz',11:'Lapis Lazuli',22:'Sapphire',33:'Emerald'};
    if(lang==='ur'){
      const m = {1:'ریڈ جیاسپر',2:'مون اسٹون',3:'سائٹرین',4:'ہیماٹائٹ',5:'ٹرکوائز',6:'روز کوارٹز',7:'امیتھسٹ',8:'سموکی کوارٹز',9:'کلئیر کوارٹز',11:'لیپس لازولی',22:'نیلم',33:'زمرد'};
      return m[n] || 'کوارٹز';
    }
    if(lang==='sr'){ return getStoneByNumber(n,'ur'); }
    return mapEN[n] || 'Clear Quartz';
  }

  /* ---------------------- Language Packs (EN / UR / SR) ---------------------- */
  // For brevity I include robust English + good Urdu + Saraiki packs (expand as needed)
  const LANG = {
    en: {
      meta:{title:'Life Path Oracle', subtitle:'Comprehensive life reading — Past · Present · Future · All aspects'},
      labels:{name:'Full Name',father:"Father's Name",dob:'Date of Birth',place:'Place of Birth (optional)',gender:'Gender (optional)',focus:'Focus / Question (optional)',predict:'Predict My Life',clear:'Clear',example:'Example'},
      sections:{overview:'Personality Overview',past:'Past & Family Influence',present:'Present Condition',future:'Future Outlook',love:'Love & Relationships',career:'Career & Wealth',health:'Health & Well-being',spirit:'Spirituality & Inner Life',advice:'Final Advice'},
      templates:{intro:'This is an in-depth reading built from your Life Path and name energies. Read reflectively.'},
      numbers:{
        traits:{
          1:'Leadership, independence, and a drive to create. You value autonomy and often take the first step where others hesitate. You are designed to initiate and lead by example.',
          2:'Cooperative, diplomatic and empathetic. You find strength through relationships and shared trust; partnerships and listening are your tools.',
          3:'Expressive, creative, and communicative. Ideas flow easily and you connect through words, art or humor; visibility helps your path.',
          4:'Practical, disciplined, and reliable. You build foundations slowly and steadily; structure and routine bring results.',
          5:'Adventurous and freedom-loving. Your life gains momentum through change and variety; adaptiveness is your asset.',
          6:'Responsible, nurturing and family-oriented. You find meaning through service, care and dependable love.',
          7:'Analytical, introspective, and spiritually inclined. You search for depth, truth and inner wisdom; solitude refines you.',
          8:'Ambitious, organized and result-driven. You aim for material mastery and influence; strategic focus rewards you.',
          9:'Compassionate, visionary and generous. You are drawn to causes larger than self and to completion of cycles.',
          11:'Highly intuitive and inspired. You are sensitive to subtler currents of meaning and visionary impulses.',
          22:'A master planner; you can turn big ideas into lasting structures and legacy work.',
          33:'A teacher-healer archetype; service, compassion and public influence are central to your path.'
        },
        pastByFather:{
          1:'Early life asked you to step forward; often responsibilities were accepted early which shaped self-reliance and initiative.',
          2:'Harmony and emotional intelligence were central at home; you learned mediation and sensitivity from family dynamics.',
          3:'Expression was a coping skill — humor, creativity or speech shaped your identity and connection to others.',
          4:'Discipline and structure dominated childhood; you were taught the value of steady effort and reliability.',
          5:'Change and movement were common; you learned flexibility and how to find opportunity in transition.',
          6:'Family duties and care were emphasized; supporting others taught you responsibility and empathy.',
          7:'Solitude and study were present; you formed deep inner resources through reflection and observation.',
          8:'Achievement expectations weighed in; performance and tangible results were valued and pursued.',
          9:'A wide, generous family perspective influenced you; empathy and broad vision formed early.',
          11:'A sensitive atmosphere refined intuition; subtle signals and insights were recognized young.',
          22:'Big thinking and blueprint-style responsibility were encouraged at home; legacy-minded lessons were given.',
          33:'Service and guidance were modeled; you learned to lead by helping others.'
        },
        presentByName:{
          1:'Current phase favors initiative — step forward with clarity and defined goals.',
          2:'Cooperation will open doors; listen and build trusted partnerships.',
          3:'This is a season of expression — share, teach, publish, or perform your ideas.',
          4:'Systems and steady work produce tangible gains. Focus on reliability.',
          5:'Movement and options appear — be selective but open to growth through change.',
          6:'Home, family and responsibilities matter — stabilize what you care about.',
          7:'Retreat for study or reflection — insight arrives through quiet focus.',
          8:'Measured ambition pays. Set clear financial targets and follow disciplined plans.',
          9:'Complete old chapters; endings prepare you for higher service and renewal.',
          11:'Record your intuitions; creative inspiration may deepen into opportunity.',
          22:'Systematize your ideas; build structures that can scale and last.',
          33:'Lead through service — teaching and healing expand your reach.'
        },
        futureByLifePath:{
          1:'A leadership opportunity is likely; prepare by clarifying responsibilities and support systems.',
          2:'A meaningful partnership or collaboration stabilizes and advances your goals.',
          3:'Recognition for creative work may come — present your voice to wider circles.',
          4:'Slow compounding structure leads to durable success; think in years, not days.',
          5:'A major change — relocation, role-shift or new venture — accelerates growth.',
          6:'Home and family roles expand; plan for resources and emotional bandwidth.',
          7:'A deep study or spiritual pivot clarifies direction and purpose.',
          8:'Financial and material gains come from disciplined execution and measured risk.',
          9:'Surrendering old patterns opens space for service and visionary aims.',
          11:'A creative or spiritual breakthrough may appear; protect your energy and refine the vision.',
          22:'Opportunity to construct legacy work; act patiently and architecturally.',
          33:'High service roles or teaching platforms appear; keep integrity central.'
        }
      },
      aspects:{
        love:{1:'You need a partner who respects initiative; shared goals build strong bonds.',2:'Emotion and diplomacy create closeness; healthy boundaries help.',3:'Expression and warmth deepen relationships.',4:'Loyalty and reliability are the foundation of committed partnerships.',5:'Adventure keeps passion alive — negotiate core values early.',6:'Deep commitment and family provide meaning.',7:'A partner who honors inner life and depth suits you.',8:'Balance career ambition with heart-felt presence.',9:'Shared service and generosity bond you to others.'},
        career:{1:'Leadership & entrepreneurship fit you; building organizations is natural.',2:'Cooperative and diplomatic work suits you.',3:'Creative & communication roles thrive under your touch.',4:'Finance, operations and engineering reward discipline.',5:'Travel, sales, and roles with variety keep you engaged.',6:'Education, care, and service-aligned careers are rewarding.',7:'Research, consultancy, and specialist fields align well.',8:'Management and wealth-creation roles reflect your potential.',9:'Nonprofit and visionary leadership fulfill your purpose.'},
        health:{1:'Prioritize physical routines; consistent exercise sustains energy.',2:'Emotional balance is health-critical; calming practices help.',3:'Creative outlets reduce stress; balance expression with rest.',4:'Routines and sleep hygiene strengthen resilience.',5:'Moderate excess; ground yourself with regular habits.',6:'Care for your boundaries to avoid burnout.',7:'Meditative practice supports mind-body health.',8:'Strength training & stress-management recommended.',9:'Set limits; compassion without boundaries risks depletion.'},
        spirit:{1:'Channel will into constructive rituals and service.',2:'Group rituals and quiet community sustain you.',3:'Creativity is a sacred path for you.',4:'Daily devotion & grounding practice build spiritual stamina.',5:'Pilgrimage or study refreshes your inner life.',6:'Service is a spiritual practice; integrate it gently.',7:'Study, silence and contemplation are key.',8:'Use material success as a platform for giving.',9:'Service leads to spiritual completion.'}
      }
    },

    // Urdu pack (concise + extended)
    ur: {
      meta:{title:'لائف پاتھ اوریکل', subtitle:'مکمل زندگی کی تشریح — ماضی · حال · مستقبل · تمام پہلو'},
      labels:{name:'پورا نام',father:'باپ کا نام',dob:'پیدائش کی تاریخ',place:'پیدائش کا مقام (اختیاری)',gender:'جنس (اختیاری)',focus:'مرکزی سوال (اختیاری)',predict:'میری زندگی بتائیں',clear:'ری سیٹ',example:'مثال'},
      sections:{overview:'شخصی خلاصہ',past:'ماضی اور خاندانی اثر',present:'موجودہ کیفیت',future:'مستقبل کی جھلک',love:'محبت و رشتے',career:'ملازمت و دولت',health:'صحت',spirit:'روحانیت',advice:'آخری مشورہ'},
      templates:{intro:'یہ گہرائی سے تیارکردہ قرأت آپ کے لائف پاتھ اور نامی توانائیوں پر مبنی ہے۔ غور سے پڑھیں۔'},
      numbers:{
        traits:{
          1:'قیادت، خودمختاری اور نئے راستے بنانے کی خواہش۔ آپ اکثر دوسروں سے آگے بڑھ کر راہ بناتے ہیں۔',
          2:'ہم آہنگی، ہمدردی اور تعلقات میں طاقت۔ آپ باہمی اعتماد میں مضبوط ہوتے ہیں۔',
          3:'تخلیقی اظہار اور مواصلت میں مہارت؛ آپ الفاظ یا فن کے ذریعے جڑتے ہیں۔',
          4:'عملی، منظم اور قابلِ اعتماد؛ مضبوط بنیادیں آپ کی پہچان ہیں۔',
          5:'آزادی پسند، تبدیلی سے سیکھتے ہیں؛ تجربہ آپ کا استاد ہے۔',
          6:'خاندانی سنبھال اور خدمت آپ کی ترجیح؛ ذمہ داری دل کو سکون دیتی ہے۔',
          7:'تجزیہ، غور و فکر اور روحانی تلاش؛ اندرونی سکوت آپ کو سنوارے گا۔',
          8:'منصوبہ بندی اور اثر کے ذریعے کامیابی؛ آپ نظم سے پیسے اور مقام بناتے ہیں۔',
          9:'ہمدرد، وژنری اور سروس سے جڑے؛ وسیع نظریہ آپ کی علامت ہے۔',
          11:'نہایت حساس اور بصیرت رکھنے والے؛ اندرونی اشارے آپ کے لیے قیمتی ہیں۔',
          22:'بڑا منصوبہ ساز؛ خیالات کو حقیقت میں بدلنے کی صلاحیت آپ میں ہے۔',
          33:'استاد اور شفا دینے والے؛ خدمت آپ کا فطری کام ہے۔'
        },
        pastByFather:{
          1:'ابتدائی زندگی میں آپ نے خود ذمہ داریاں سنبھالیں؛ حوصلہ اور قیادت پروان چڑھی۔',
          2:'گھر میں میل جول اور بات چیت نے آپ کو حساس اور مفاہمتی بنایا۔',
          3:'اظہار نے آپ کی شناخت بنائی—فن یا مذاق نے مشکلات کم کیں۔',
          4:'نظم و ضبط اور محنت نے آپ کی قدر اور برداشت بنائی۔',
          5:'تبدیلی اور حرکت نے آپ کو لچکدار بنایا۔',
          6:'خاندانی فرائض نے خدمت اور قربانی سکھائی۔',
          7:'تنہائی اور مطالعے نے اندرونی بصیرت دی۔',
          8:'کامیابی کی توقع نے کارکردگی اور محنت میں ڈالا۔',
          9:'وسیع نظریہ نے ہمدردی اور سخاوت دی۔',
          11:'حساس گھرانے نے آپ کی بصیرت کو تیز کیا۔',
          22:'گھر میں بڑے منصوبے اور ذمہ داریاں سکھائی گئیں۔',
          33:'خدمت اور رہنمائی کو گھر میں مثال بنایا گیا۔'
        },
        presentByName:{
          1:'فی الحال قیادت کا وقت ہے—صاف فیصلے کریں۔',
          2:'تعاون سے کامیابی ملے گی—رشتہ بنائیں۔',
          3:'اب اظہار کا وقت ہے—اپنے خیالات ظاہر کریں۔',
          4:'نظم و ضبط کے ساتھ کام کریں—پائیدار نتائج آئیں گے۔',
          5:'نئی راہیں کھلی ہیں—سمجھداری سے چنیں۔',
          6:'خاندانی فرائض اور تعلقات اہم ہیں—توازن بنائیں۔',
          7:'گہرائی میں جا کر مطالعہ کریں—جواب ملے گا۔',
          8:'مالی منصوبہ بندی اور عمل سے فائدہ ہوگا۔',
          9:'پرانے چکروں کو ختم کریں—نئی شروعات کیلئے جگہ بنائیں۔',
          11:'اندرونی اشاروں پر بھروسہ کریں—نوٹ کریں۔',
          22:'اپنے وژن کو عملی نظام میں بدلیں۔',
          33:'خدمت کے ذریعے لوگوں کی رہنمائی کریں۔'
        },
        futureByLifePath:{
          1:'قریب مستقبل میں قیادتی موقع مل سکتا ہے—تیاری رکھیں۔',
          2:'ایک پائیدار شراکت آپ کی راہ ہموار کرے گی۔',
          3:'تخلیقی کام کی پہچان مل سکتی ہے—اپنے کام کو سامنے لائیں۔',
          4:'مسلسل کوشش سے مضبوط بنیادیں بنیں گی۔',
          5:'نئی جگہ یا کردار تبدیلی لائے گا—ترقی ممکن ہے۔',
          6:'گھر اور ذمہ داریاں بڑھیں گی—منصوبہ بندی ضروری ہے۔',
          7:'گہری تعلیم یا روحانی رخ آپ کی راہ ہموار کرے گا۔',
          8:'نظم و ضبط سے مالی کامیابی حاصل ہوگی۔',
          9:'پرانا چھوڑ کر خدمت اور نئی راہ ممکن ہے۔',
          11:'تخلیقی یا روحانی بریک تھرو ممکن ہے۔',
          22:'وراثتی یا بڑا منصوبہ آپ کے سامنے آسکتا ہے۔',
          33:'عوامی خدمت اور اثر کے نئے دروازے کھل سکتے ہیں۔'
        }
      },
      aspects:{
        love:{1:'رشتوں میں خودمختاری ضروری—شراکت میں واضح حدود بنائیں۔',2:'احساس اور ہمدردی رشتے مضبوط کرتی ہے۔',3:'اظہار اور بات چیت محبت کو گہرا کرتی ہیں۔',4:'وفاداری اور اعتماد رشتے میں اہم ہیں۔',5:'سفر اور تجربے رشتے میں تازگی لاتے ہیں۔',6:'گہری وابستگی گھر کو مضبوط بناتی ہے۔',7:'شریکِ حیات کو جگہ اور ذہنی ہم آہنگی چاہیے۔',8:'پیشہ ورانہ مقاصد رشتوں کو متاثر کرسکتے ہیں—توازن اہم۔',9:'خدمت اور سخاوت رشتوں کو معنی دیتی ہیں۔'},
        career:{1:'قیادت اور کاروبار آپ کے لیے موزوں ہیں۔',2:'شراکت دارانہ شعبے فائدہ مند ہیں۔',3:'تخلیقی اور مواصلاتی شعبے میں کامیابی ممکن ہے۔',4:'انتظام اور مالی شعبے میں نظم آپ کا ہنر بن سکتا ہے۔',5:'سفر اور بدلتے شعبے آپ کو فعال رکھتے ہیں۔',6:'تعلیم و خدمت کے شعبے آپ کو سکون دیں گے۔',7:'تحقیقی اور مشاورتی شعبے آپ کے بارے میں ہیں۔',8:'انتظامی اور مالی ذمہ داریاں آپ کے لیے سازگار ہوں گی۔',9:'خیراتی اور وژنری کام آپ کو پورا کریں گے۔'},
        health:{1:'جسمانی معمولات پر توجہ دیں؛ ورزش مفید رہے گی۔',2:'جذباتی سکون آپ کی صحت کی کلید ہے۔',3:'تخلیقی مشغلے ذہن کو سکون دیں گے۔',4:'محفوظ روٹین صحت کو بہتر کرے گی۔',5:'زیادہ جوش کو قابو میں رکھیں۔',6:'دیگران کی خدمت کرتے ہوئے حد بنائیں۔',7:'تأمل اور سکون مفید ہیں۔',8:'طاقت اور استقامت کے ساتھ توازن ضروری ہے۔',9:'خود کو جلانے سے بچائیں؛ آرام لیں۔'},
        spirit:{1:'اپنی قوت کو مثبت مقصد میں لگائیں۔',2:'اجتماعی رسومات سکون پہنچائیں گی۔',3:'فن کو عبادت سمجھیں؛ روحانی کنکشن ملے گا۔',4:'روزمرہ عبادت آپ کو مضبوط کرے گی۔',5:'نئے رہنما راستے تلاش کریں۔',6:'خدمت روحانیت کا ذریعہ ہے۔',7:'گہرائی میں مطالعہ روحانیت کو مضبوط کرے گا۔',8:'کامیابی کو سخاوت میں تبدیل کریں۔',9:'خدمت روحانی تکمیل کا راستہ ہے۔'}
      }
    },

    // Saraiki pack (concise respectful)
    sr: {
      meta:{title:'زندگی دا راستہ', subtitle:'مکمل پڑھائی — ماضی · حال · مستقبل · سارے پہلو'},
      labels:{name:'پورا ناں',father:'والد دا ناں',dob:'جنم دی تاریخ',place:'پیدائش دا شہر (اختیاری)',gender:'جنس (اختیاری)',focus:'مرکزی سوال (اختیاری)',predict:'مینوں دساں',clear:'ری سیٹ',example:'مثال'},
      sections:{overview:'شخصی حال',past:'ماضی تے خاندان',present:'موجودہ حال',future:'آئندہ دا منظر',love:'محبت تے رشتے',career:'روزگار تے دولت',health:'صحت',spirit:'روحانیت',advice:'آخری ہدایت'},
      templates:{intro:'ایہ پڑھائی جنم تے ناں دیاں توانائیاں توں بنی اے؛ غور نال ویکھو۔'},
      numbers:{
        traits:{
          1:'رہنمائی تے خودمختاری پسند؛ تُسی اگے بڑھن والے او۔',
          2:'نرمی تے میل جول؛ تعلقات وچ طاقت لبھو۔',
          3:'اظہار تے فن توں ناتا؛ گل بات توانو اگے لیجاندی اے۔',
          4:'مضبوط بنیاد تے نظم پسند؛ محنت دا پھل ملدا اے۔',
          5:'سفر تے تبدیلی توں ترقی ہوندی اے؛ آزادي پسند او۔',
          6:'گھر تے خدمت تہانڑی پہچان نیں۔',
          7:'گہرائی وچ سوچ تے روحانی تلاش ؛ سکوت توں جواب لبھو۔',
          8:'منصوبہ بندی نال کامیابی؛ نظم نال ترقی میسر اے۔',
          9:'وسعت پسند تے ہمدرد؛ وڈی سوچ رکھو۔',
          11:'حساس تے باخبر؛ اندرلی آواز نوں سُنو۔',
          22:'وڈی سوچ نوں حقیقت وچ بدلنا تمہاری خوبی اے۔',
          33:'لوکاں نوں سکھان تے سنبھالن دا کم تمہاری پہچان اے۔'
        },
        pastByFather:{
          1:'بچپن وچ ذمے واریاں سنبھالیاں؛ ہمت ودھی۔',
          2:'گھر وچ میل جول تہاڈی طاقت بنی۔',
          3:'اظہار تے فن نال پہچان بنئی۔',
          4:'نظم نال محنت سکھی؛ ذمے داری ملی۔',
          5:'ہلچل نال لچک آئی۔',
          6:'خاندانی خدمت تہاڈی شکل بن گئی۔',
          7:'اکیلی سوچ تہاڈی عادت بنی۔',
          8:'کامیابی دیاں امیداں نے محنت سکھائی۔',
          9:'وسیع نظریے نال ہمدردی ودھی۔',
          11:'حساس ماحول نے بصیرت نوں پروان چڑھایا۔',
          22:'گھر وچ وڈی سوچ تے ذمہ داریاں ملیں۔',
          33:'خدمت دا ماحول تہاڈے کول سی۔'
        },
        presentByName:{
          1:'وقت اے آگے ودھنے دا؛ صاف فیصلے کرو۔',
          2:'ساتھ کم کر کے فائدہ ہووے گا۔',
          3:'اپنی گل کہو؛ لوک سنن گے۔',
          4:'نظم اپناؤ؛ نتیجہ ملے گا۔',
          5:'تحریک تے نواں کم تھواڈا انتظار کردے نیں۔',
          6:'گھر تے رشتیاں نوں ترجیح دو۔',
          7:'گہرائی وچ جا کے سکون لبھو۔',
          8:'منصوبہ بندی نال مالی فائدہ ہووے گا۔',
          9:'پرانیاں چیزاں مکاؤ؛ نویاں راہیں کھولو۔',
          11:'اندرلی اشاریاں تے عمل سوچو۔',
          22:'اپنے خیال نوں نظام وچ بدلو۔',
          33:'خدمت کرے لوک تہاڈی قدر کرنگے۔'
        },
        futureByLifePath:{
          1:'قریب وقت وچ قیادت دا موقع آ سکدا اے۔',
          2:'شراکت داری تھواڈے لئی فائدہ مند ہوئے گی۔',
          3:'تخلیقی کم نو پہچان ملے گی۔',
          4:'محنت دا پھل لمے عرصے وچ ملے گا۔',
          5:'نواں سفر یا تبدیلی ترقی لیائے گی۔',
          6:'گھر دی ذمہ داریاں ودھن گیاں — منصوبہ بندی ضروری اے۔',
          7:'مطالعہ تے سکون نال راہ صاف ہووے گی۔',
          8:'نظم نال مالی فائدہ ہووے گا۔',
          9:'پرانی عادات چھڈ کے خدمت شروع کرو۔',
          11:'روحانی یا تخلیقی بریک تھرو ہوسکدا اے۔',
          22:'وراثتی کم کرن لئی موقع مل سکتا اے۔',
          33:'خدمت دا اثر وڈا ہووے گا۔'
        }
      },
      aspects:{
        love:{1:'آزادی پسند؛ رشتے وچ عزت ضروری اے۔',2:'نرم دلی نال رشتہ مضبوط رہے گا۔',3:'اظہار رشتے نوں گہرا کرے گا۔',4:'وفاداری رشتے نوں مضبوط رکھدی اے۔',5:'سفر تے تجربے محبت نو زندہ رکھدے نیں۔',6:'گہرے رشتے زندگی دے مرکز ہون گے۔',7:'شریکِ حیات نوں جگہ دیو۔',8:'کیرئیر رشتیاں تے اثر انداز ہو سکدا اے۔',9:'خدمت رشتیاں نوں معنی دیندی اے.'},
        career:{1:'قیادت یا کاروبار مناسب اے۔',2:'ساتھ کم کرن والیاں شعبیاں چ چنگا ملے گا۔',3:'تخلیقی شعبہ چ تمہاری پہچان بنے گی۔',4:'منصوبہ بندی تے نظم توانو فائدہ دے گا۔',5:'بدلاؤ والے شعبے توانوں متحرک رکھن گے۔',6:'تعلیم تے خدمت نوں ترجیح دو۔',7:'تحقیقی کم فائدہ مند رہیں گے۔',8:'انتظامی عہدے چ ترقی ممکن اے۔',9:'خیراتی تے وڈے مقصد والے کم تسیں نوں پورا کرن گے.'},
        health:{1:'روزانہ ورزش مفید اے؛ جسمانی معمول رکھو۔',2:'جذباتی سکون ضروری اے۔',3:'تخلیقی مشغلے ذہن نوں سکون دیندے نیں۔',4:'روٹین نال صحت مضبوط ہوندی اے۔',5:'زیادہ جوش نوں قابو کر لو۔',6:'دوسراں دی خدمت وچ حد بناؤ۔',7:'تأمل تے سکون نال طاقت ملدی اے۔',8:'طاقت ور ورزش تے توازن رکھو۔',9:'اپنے آپ نوں بچا کے رکھو۔'},
        spirit:{1:'طاقت نوں مثبت کم وچ لگاؤ۔',2:'اجتماعی رسومات سکون دین گیاں۔',3:'فن نوں عبادت سمجھ کے اپناؤ۔',4:'روزمرہ ارادے روح نوں مضبوط کردے نیں۔',5:'نواں روحانی راستہ تلاش کرو۔',6:'خدمت روحانیت نوں مضبوط کرے گی۔',7:'گہرائی نال مطالعہ ضروری اے۔',8:'کامیابی نوں سخاوت وچ بدلو۔',9:'خدمت روحانی تسکین دا ذریع اے۔'}
      }
    }
  };

  /* ---------------------- Build Reading ---------------------- */

  function buildReading(payload, lang='en'){
    const L = LANG[lang] || LANG.en;
    const name = (payload.name||'').trim();
    const father = (payload.father||'').trim();
    const dob = (payload.dob||'').trim();
    const place = (payload.place||'').trim();
    const gender = (payload.gender||'').trim();
    const focus = (payload.focus||'').trim();

    const lifePath = lifePathFromDOB(dob);
    const nameNum = nameNumber(name);
    const fatherNum = nameNumber(father);

    if(!name || !father || !dob || !lifePath || !nameNum || !fatherNum){
      return { error: (lang==='ur'? 'براہ کرم تمام ضروری فیلڈز پُر کریں۔' : (lang==='sr' ? 'مکمل فارم پُر کرو' : 'Please provide valid Name, Father Name and DOB.')) };
    }

    const trait = L.numbers.traits[lifePath] || L.templates.intro || 'Balanced life tendencies';
    const past = L.numbers.pastByFather[fatherNum] || '';
    const present = L.numbers.presentByName[nameNum] || '';
    const future = L.numbers.futureByLifePath[lifePath] || '';
    const love = (L.aspects && L.aspects.love && L.aspects.love[lifePath]) || '';
    const career = (L.aspects && L.aspects.career && L.aspects.career[lifePath]) || '';
    const health = (L.aspects && L.aspects.health && L.aspects.health[lifePath]) || '';
    const spirit = (L.aspects && L.aspects.spirit && L.aspects.spirit[lifePath]) || '';

    const personality = `${trait} ${L.templates && L.templates.intro ? (' ' + L.templates.intro) : ''}`;
    const detailedPast = `${past} ${father ? '' : ''}`;
    const detailedPresent = `${present} ${place ? (' ' + place) : ''}`;
    const detailedFuture = `${future} ${focus ? (' Focus: ' + focus) : ''}`;

    const luckyNumber = lifePath;
    const luckyColor = getColorNameByNumber(luckyNumber, lang);
    const luckyStone = getStoneByNumber(luckyNumber, lang);

    const createdAt = new Date().toISOString();

    return {
      name, father, dob, place, gender, focus,
      lifePath, nameNum, fatherNum,
      personality, detailedPast, detailedPresent, detailedFuture,
      love, career, health, spirit,
      luckyNumber, luckyColor, luckyStone, createdAt, lang
    };
  }

  /* ---------------------- UI Handling ---------------------- */

  const form = document.getElementById('form');
  const langSel = document.getElementById('langSel');
  const resultArea = document.getElementById('resultArea');
  const resName = document.getElementById('resName');
  const resSub = document.getElementById('resSub');
  const chips = document.getElementById('chips');
  const kpis = document.getElementById('kpis');
  const sections = document.getElementById('sections');
  const lifePathChip = document.getElementById('lifePathChip');
  const nameNumChip = document.getElementById('nameNumChip');
  const fatherNumChip = document.getElementById('fatherNumChip');
  const signature = document.getElementById('signature');

  // History storage
  let HISTORY = JSON.parse(localStorage.getItem('lp_history_v1')||'[]');

  function renderReading(r){
    if(r.error){ alert(r.error); return; }
    // show area
    resultArea.style.display = 'block';
    resName.textContent = `${r.name} (${r.dob})`;
    resSub.textContent = r.focus ? `Focus: ${r.focus}` : 'Detailed life reading';
    chips.innerHTML = `<span class="chip">Life Path ${r.lifePath}</span> <span class="chip">Name# ${r.nameNum}</span> <span class="chip">Father# ${r.fatherNum}</span>`;

    kpis.innerHTML = `
      <div class="kpi"><div class="label">Core Trait</div><div class="value">${LANG[r.lang].numbers.traits[r.lifePath] ? '' : ''}</div></div>
      <div class="kpi"><div class="label">Lucky #</div><div class="value">${r.luckyNumber}</div></div>
      <div class="kpi"><div class="label">Lucky Color</div><div class="value">${r.luckyColor}</div></div>
    `;

    // sections
    sections.innerHTML = '';
    const secOrder = ['overview','past','present','future','love','career','health','spirit','advice'];
    secOrder.forEach(key=>{
      let header = LANG[r.lang].sections[key] || key;
      let body = '';
      if(key==='overview') body = `<p>${r.personality}</p>`;
      else if(key==='past') body = `<p>${r.detailedPast}</p><p>${LANG[r.lang].numbers.pastByFather[r.fatherNum] || ''}</p>`;
      else if(key==='present') body = `<p>${r.detailedPresent}</p><p>${LANG[r.lang].numbers.presentByName[r.nameNum] || ''}</p>`;
      else if(key==='future') body = `<p>${r.detailedFuture}</p><p>${LANG[r.lang].numbers.futureByLifePath[r.lifePath] || ''}</p>`;
      else if(key==='love') body = `<p>${r.love}</p>`;
      else if(key==='career') body = `<p>${r.career}</p>`;
      else if(key==='health') body = `<p>${r.health}</p>`;
      else if(key==='spirit') body = `<p>${r.spirit}</p>`;
      else if(key==='advice') body = `<p>${langSel.value==='ur' ? 'عملی اقدامات: 30 دن کا روزانہ جرنل رکھیں، 90 دن کے منصوبے بنائیں، اور مشورہ لیں۔' : (langSel.value==='sr' ? 'عملی ہدایات: 30 دن دا جرنل رکھو تے 90 دن لئی مقاصد طے کرو۔' : 'Practical steps: Keep a 30-day journal. Set 90-day goals aligned with your Life Path. Seek mentorship and do a health check if needed.')}</p>`;

      const node = document.createElement('div'); node.className='tile'; node.innerHTML = `<h3>${header}</h3>${body}`;
      sections.appendChild(node);
    });

    signature.textContent = '✨ Created by BHuTTa ✨';
    signature.style.color = 'var(--gold)';

    // set aside chips
    lifePathChip.textContent = 'Life Path: ' + r.lifePath;
    nameNumChip.textContent = 'Name #: ' + r.nameNum;
    fatherNumChip.textContent = "Father #: " + r.fatherNum;

    // Update URL for sharing
    const params = new URLSearchParams();
    params.set('name', r.name);
    params.set('father', r.father);
    params.set('dob', r.dob);
    if(r.place) params.set('place', r.place);
    if(r.gender) params.set('gender', r.gender);
    if(r.focus) params.set('focus', r.focus);
    params.set('lang', r.lang);
    params.set('autopredict','1');
    history.replaceState(null,'',location.pathname + '?' + params.toString());
  }

  // Save to history (stores the whole reading)
  function saveReadingToHistory(reading){
    reading.id = Date.now().toString(36);
    HISTORY.unshift(reading); // latest first
    localStorage.setItem('lp_history_v1', JSON.stringify(HISTORY));
    alert(langSel.value==='ur' ? 'قرأت محفوظ ہوگئی' : (langSel.value==='sr' ? 'ریکارڈ محفوظ ہو گیا' : 'Reading saved'));
  }

  // Copy reading text
  document.getElementById('copyBtn').addEventListener('click', ()=>{
    if(resultArea.style.display==='none'){ alert('No reading'); return; }
    let text = resName.textContent + '\n\n';
    Array.from(sections.querySelectorAll('.tile')).forEach(t => {
      const h = t.querySelector('h3').textContent.trim();
      const p = t.querySelector('p') ? t.querySelector('p').textContent.trim() : '';
      text += h + '\n' + p + '\n\n';
    });
    navigator.clipboard.writeText(text).then(()=> alert(langSel.value==='ur' ? 'قرأت کلپ بورڈ پر کاپی ہو گئی' : (langSel.value==='sr' ? 'ریڈنگ کلپ بورڈ وچ کاپی ہو گئی' : 'Reading copied to clipboard'))).catch(()=> prompt('Copy reading:', text));
  });

  // Download single reading as PDF (render resultArea)
  document.getElementById('downloadSingleBtn').addEventListener('click', async ()=>{
    if(resultArea.style.display==='none'){ alert('No reading'); return; }
    await exportElementToPDF(document.querySelector('.tile'), (document.getElementById('name').value||'reading') + '.pdf');
  });

  // Quick Example fills form with demo
  document.getElementById('quickExample').addEventListener('click', ()=>{
    document.getElementById('name').value = 'Aisha Khan';
    document.getElementById('father').value = 'Khan Muhammad';
    document.getElementById('dob').value = '1998-03-12';
    document.getElementById('place').value = 'Multan, Pakistan';
    document.getElementById('gender').value = 'Female';
    document.getElementById('focus').value = 'career';
  });

  // Predict form submit
  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    const payload = Object.fromEntries(new FormData(form).entries());
    const lang = langSel.value || 'en';
    const reading = buildReading(payload, lang);
    if(reading.error){ alert(reading.error); return; }
    renderReading(reading);
    // auto-save a summary to history
    saveReadingToHistory(reading);
  });

  // Save button (also available)
  document.getElementById('saveLocalBtn').addEventListener('click', ()=>{
    // try to rebuild reading from current UI (safer to re-run using form state)
    const payload = Object.fromEntries(new FormData(form).entries());
    const reading = buildReading(payload, langSel.value || 'en');
    if(reading.error){ alert(reading.error); return; }
    saveReadingToHistory(reading);
    renderHistory(); // update modal list
  });

  /* ---------------------- History Modal & Management ---------------------- */

  const overlay = document.getElementById('overlay');
  const modal = document.getElementById('modal');
  const historyBtn = document.getElementById('historyBtn');
  const closeModalBtn = document.getElementById('closeModalBtn');
  const clearAllBtn = document.getElementById('clearAllBtn');
  const exportAllBtn = document.getElementById('exportAllBtn');
  const histSearch = document.getElementById('histSearch');

  historyBtn.addEventListener('click', openHistory);
  closeModalBtn.addEventListener('click', closeHistory);
  overlay.addEventListener('click', closeHistory);

  clearAllBtn.addEventListener('click', ()=>{
    if(!HISTORY.length) return;
    if(confirm(langSel.value==='ur' ? 'کیا آپ واقعی سب حذف کرنا چاہتے ہیں؟' : (langSel.value==='sr' ? 'کیا تسی واقعی سب مٹانا چاندے او؟' : 'Are you sure you want to clear all history?'))){
      HISTORY = [];
      localStorage.removeItem('lp_history_v1');
      renderHistory();
    }
  });

  exportAllBtn.addEventListener('click', async ()=>{
    if(!HISTORY.length){ alert(langSel.value==='ur' ? 'کوئی محفوظ قرأت نہیں' : (langSel.value==='sr' ? 'کوئی ریکارڈ نئیں' : 'No saved readings')); return; }
    await downloadHistoryAsPDF();
  });

  function openHistory(){
    overlay.style.display = 'flex';
    modal.classList.add('open');
    renderHistory();
  }
  function closeHistory(){
    overlay.style.display = 'none';
    modal.classList.remove('open');
  }

  function renderHistory(){
    const list = document.getElementById('historyList');
    list.innerHTML = '';
    const q = (histSearch.value||'').toLowerCase().trim();
    const filtered = HISTORY.filter(item => {
      if(!q) return true;
      return (item.name||'').toLowerCase().includes(q) || (item.dob||'').includes(q) || (item.createdAt||'').toLowerCase().includes(q);
    });
    if(!filtered.length){ list.innerHTML = `<div style="color:var(--muted);padding:12px">No records</div>`; return; }

    filtered.forEach(item=>{
      const el = document.createElement('div'); el.className = 'history-card';
      const created = new Date(item.createdAt).toLocaleString();
      el.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:800">${item.name} <span style="color:var(--muted);font-weight:600">• ${item.dob}</span></div>
            <div class="meta"><div>${created}</div><div style="color:var(--muted)">${item.luckyColor} • #${item.luckyNumber}</div></div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px">
            <button class="btn ghost" title="View" onclick='viewHistoryItem("${item.id}")'>View</button>
            <button class="btn-danger" title="Delete" onclick='deleteHistoryItem("${item.id}")'>Delete</button>
          </div>
        </div>
        <div style="margin-top:8px;color:var(--muted);font-size:13px">${(item.focus?('Focus: '+item.focus):'')}</div>
      `;
      list.appendChild(el);
    });
  }

  // View single history - open a small modal-like area showing details (we'll reuse main result area)
  window.viewHistoryItem = function(id){
    const item = HISTORY.find(h=>h.id===id);
    if(!item) return alert('Not found');
    // populate form with this item (so user can re-run if needed)
    document.getElementById('name').value = item.name || '';
    document.getElementById('father').value = item.father || '';
    document.getElementById('dob').value = item.dob || '';
    document.getElementById('place').value = item.place || '';
    document.getElementById('gender').value = item.gender || '';
    document.getElementById('focus').value = item.focus || '';
    // render reading
    renderReading(item);
    closeHistory();
  };

  window.deleteHistoryItem = function(id){
    if(!confirm(langSel.value==='ur' ? 'حذف کریں؟' : (langSel.value==='sr' ? 'کیا مٹانا اے؟' : 'Delete this entry?'))) return;
    HISTORY = HISTORY.filter(h=>h.id!==id);
    localStorage.setItem('lp_history_v1', JSON.stringify(HISTORY));
    renderHistory();
  };

  /* ---------------------- PDF Exports ---------------------- */

  async function exportElementToPDF(el, filename='reading.pdf'){
    // render provided element with html2canvas then create multi-page pdf if needed
    const canvas = await html2canvas(el, {scale:2, useCORS:true, logging:false});
    const imgData = canvas.toDataURL('image/jpeg', 0.95);
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({unit:'pt', format:'a4'});
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const imgProps = pdf.getImageProperties(imgData);
    const pdfWidth = pageWidth - 40;
    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
    let y = 20;
    pdf.addImage(imgData,'JPEG',20,y,pdfWidth,pdfHeight);
    pdf.setFontSize(10);
    pdf.text('Generated by Life Path Oracle — Created by BHuTTa', 30, pageHeight - 30);
    pdf.save(filename);
  }

  async function downloadHistoryAsPDF(){
    // build an offscreen container with all history entries styled, then render
    const container = document.createElement('div');
    container.style.padding = '18px';
    container.style.background = '#0b1220';
    container.style.color = '#fff';
    container.style.width = '900px';
    container.style.fontFamily = 'Inter, system-ui, -apple-system, "Noto Nastaliq Urdu", sans-serif';
    HISTORY.forEach((it, idx)=>{
      const block = document.createElement('div');
      block.style.padding = '12px';
      block.style.marginBottom = '12px';
      block.style.borderRadius = '8px';
      block.style.background = '#071219';
      block.innerHTML = `<h2 style="margin:0;color:${idx%2? '#ffd873':'#b38bff'}">${it.name} — ${it.dob}</h2>
        <div style="color:#cbd5e1;margin-top:6px">${new Date(it.createdAt).toLocaleString()}</div>
        <div style="margin-top:8px;color:#e0e7ff"><strong>Life Path:</strong> ${it.lifePath} &nbsp; <strong>Lucky:</strong> ${it.luckyNumber} • ${it.luckyColor}</div>
        <div style="margin-top:8px;color:#d1d5db">${it.personality}</div>
        <div style="margin-top:8px;color:#d1d5db"><strong>Past:</strong> ${it.detailedPast}</div>
        <div style="margin-top:8px;color:#d1d5db"><strong>Present:</strong> ${it.detailedPresent}</div>
        <div style="margin-top:8px;color:#d1d5db"><strong>Future:</strong> ${it.detailedFuture}</div>
      `;
      container.appendChild(block);
    });

    document.body.appendChild(container);
    try{
      await exportElementToPDF(container, 'LifePath_History.pdf');
    }catch(err){
      alert('Export failed: ' + err.message);
    } finally{
      document.body.removeChild(container);
    }
  }

  /* ---------------------- Share link (copy current URL with params) ---------------------- */

  document.getElementById('shareBtn').addEventListener('click', ()=>{
    const url = location.href;
    navigator.clipboard.writeText(url).then(()=> alert(langSel.value==='ur' ? 'لنک کلپ بورڈ پر کاپی ہوگیا' : (langSel.value==='sr' ? 'لنک کلپ بورڈ وچ کاپی ہو گیا' : 'Link copied to clipboard'))).catch(()=> prompt('Copy link:', url));
  });

  /* ---------------------- Init from query string ---------------------- */

  (function initFromQuery(){
    const q = new URLSearchParams(location.search);
    ['name','father','dob','place','gender','focus'].forEach(k=>{
      if(q.has(k) && document.getElementById(k)) document.getElementById(k).value = q.get(k);
    });
    const lang = q.get('lang') || 'en';
    if(['en','ur','sr'].includes(lang)) langSel.value = lang;
    // apply language UI
    applyLanguage(langSel.value);
    if(q.get('autopredict') === '1'){
      // simulate submit
      const payload = Object.fromEntries(new FormData(form).entries());
      const r = buildReading(payload, langSel.value);
      if(!r.error) renderReading(r);
    }
  })();

  /* ---------------------- Language UI adaptation ---------------------- */

  function applyLanguage(code){
    const L = (LANG[code]||LANG.en);
    document.getElementById('appTitle').textContent = L.meta.title;
    document.getElementById('appSubtitle').textContent = L.meta.subtitle;
    document.getElementById('lblName').textContent = L.labels.name;
    document.getElementById('lblFather').textContent = L.labels.father;
    document.getElementById('lblDob').textContent = L.labels.dob;
    document.getElementById('lblPlace').textContent = L.labels.place;
    document.getElementById('lblGender').textContent = L.labels.gender;
    document.getElementById('lblFocus').textContent = L.labels.focus;
    document.getElementById('predictBtn').textContent = L.labels.predict || 'Predict';
    document.getElementById('quickExample').textContent = L.labels.example || 'Example';
    document.getElementById('asideTitle').textContent = L.meta.title + ' — Quick Info';
    document.getElementById('asideText').textContent = L.templates && L.templates.intro ? L.templates.intro : '';
    renderHistory(); // update labels if necessary
  }

  langSel.addEventListener('change', ()=>{
    applyLanguage(langSel.value);
  });

  // ensure HISTORY renders initially
  renderHistory();

  </script>
</body>
</html>
